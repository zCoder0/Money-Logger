{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/media/logo/logo.png">
    <title>Analytics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Reset & Body */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #f5f6fa; color: #2c3e50; min-height: 100vh; }

        /* Header */
        .header { background: #4facfe; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); padding: 25px 0; text-align: center; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 2rem; font-weight: 700; }

        /* Container */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Month Navigation */
        .month-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 30px; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .month-nav a { background: #4facfe; color: #fff; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s; }
        .month-nav a:hover { background: #3498db; transform: translateY(-1px); }
        .current-month { font-size: 1.2rem; font-weight: 700; color: #2c3e50; }

        /* Back Button */
        .back-btn { display: inline-flex; align-items: center; gap: 8px; background: #fff; color: #4facfe; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; transition: all 0.3s; }
        .back-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }

        /* Cards */
        .card { background: #fff; padding: 20px; border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); }

        /* Summary Cards */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-value { font-size: 1.6rem; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 0.85rem; color: #7f8c8d; }
        .income { border-left: 4px solid #2ecc71; }
        .expense { border-left: 4px solid #e74c3c; }
        .balance { border-left: 4px solid #3498db; }
        .transactions { border-left: 4px solid #f39c12; }

        /* Chart Container */
        .chart-container { position: relative; height: 350px; margin-top: 15px; }
        .chart-small { height: 280px; }

        /* Table */
        .table-wrapper { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #f1f2f6; }
        th { background: #f8f9fa; color: #2c3e50; font-weight: 600; font-size: 0.9rem; }
        td { font-size: 0.9rem; }
        tr:hover { background: #f8f9ff; }

        /* Section Headers */
        h2 { color: #2c3e50; margin-bottom: 15px; font-weight: 700; font-size: 1.3rem; }
        h3 { color: #34495e; margin-bottom: 20px; font-weight: 600; font-size: 1.1rem; }

        /* Laptop/Desktop Responsive */
        @media(min-width:1024px){
            .container { max-width: 1400px; padding: 30px; }
            .summary-grid { grid-template-columns: repeat(4, 1fr); gap: 25px; }
            .stat-card { padding: 25px; }
            .stat-value { font-size: 2rem; }
            .grid-2 { grid-template-columns: 1fr 1fr; }
            .chart-container { height: 400px; }
            .chart-small { height: 320px; }
            .card { padding: 30px; }
        }
        
        @media(min-width:1440px){
            .container { max-width: 1600px; }
            .grid { grid-template-columns: repeat(3, 1fr); }
            .chart-container { height: 450px; }
            .chart-small { height: 350px; }
        }
        
        /* Responsive */
        @media(max-width:768px){
            .container { padding: 10px; }
            .month-nav { flex-direction: column; gap: 10px; padding: 12px; }
            .month-nav a { padding: 10px 16px; }
            .summary-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
            .stat-card { padding: 15px; }
            .stat-value { font-size: 1.3rem; }
            .stat-label { font-size: 0.8rem; }
            .grid { grid-template-columns: 1fr; gap: 15px; }
            .card { padding: 15px; margin-bottom: 15px; }
            .chart-container { height: 250px; }
            h2 { font-size: 1.1rem; }
            h3 { font-size: 1rem; }
            .table-wrapper { overflow-x: auto; }
        }
        
        @media(max-width:480px){
            .container { padding: 8px; }
            .summary-grid { grid-template-columns: 1fr 1fr; gap: 6px; }
            .stat-card { padding: 12px; }
            .stat-value { font-size: 1.1rem; }
            .stat-label { font-size: 0.75rem; }
            .card { padding: 12px; }
            .chart-container { height: 220px; }
            .category-breakdown { display: block !important; }
            .category-breakdown > div { margin-bottom: 20px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px;">
            <h1><img src="/media/logo/logo.png" alt="Logo" style="height: 40px; vertical-align: middle; margin-right: 10px;">Analytics Dashboard</h1>
            <div style="color: #fff; font-size: 0.9rem; opacity: 0.9;">
                Welcome, {{ user.username }}!
            </div>
        </div>
    </div>

    <div class="container">
        <a href="{% url 'dashboard' %}" class="back-btn">‚Üê Back to Dashboard</a>
        
        <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
            <a href="{% url 'logout' %}" style="background: #e74c3c; color: #fff; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">üö™ Logout</a>
        </div>

        <!-- Month Navigation -->
        <div class="month-nav">
            <a href="?month={{ prev_month }}&year={{ prev_year }}">‚Üê Previous</a>
            <div class="current-month">{{ month_name }} {{ selected_year }}</div>
            <a href="?month={{ next_month }}&year={{ next_year }}">Next ‚Üí</a>
        </div>

        <!-- Overall Summary -->
        <div class="card">
            <h2>Overall Financial Summary</h2>
            <div class="summary-grid">
                <div class="stat-card income">
                    <div class="stat-value">‚Çπ{{ total_income|floatformat:0|intcomma }}</div>
                    <div class="stat-label">Total Income</div>
                </div>
                <div class="stat-card expense">
                    <div class="stat-value">‚Çπ{{ total_expense|floatformat:0|intcomma }}</div>
                    <div class="stat-label">Total Expense</div>
                </div>
                <div class="stat-card balance">
                    <div class="stat-value">‚Çπ{{ balance|floatformat:0|intcomma }}</div>
                    <div class="stat-label">Net Balance</div>
                </div>
                <div class="stat-card transactions">
                    <div class="stat-value">{{ total_transactions }}</div>
                    <div class="stat-label">Total Transactions</div>
                </div>
            </div>
        </div>

        <!-- Current Month Summary -->
        <div class="card">
            <h2>{{ month_name }} {{ selected_year }} Summary</h2>
            <div class="summary-grid">
                <div class="stat-card income">
                    <div class="stat-value">‚Çπ{{ month_income|floatformat:0|intcomma }}</div>
                    <div class="stat-label">Month Income</div>
                </div>
                <div class="stat-card expense">
                    <div class="stat-value">‚Çπ{{ month_expense|floatformat:0|intcomma }}</div>
                    <div class="stat-label">Month Expense</div>
                </div>
                <div class="stat-card balance">
                    <div class="stat-value">‚Çπ{{ month_balance|floatformat:0|intcomma }}</div>
                    <div class="stat-label">Month Balance</div>
                </div>
                <div class="stat-card transactions">
                    <div class="stat-value">{{ month_transaction_count }}</div>
                    <div class="stat-label">Month Transactions</div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-2">
            <!-- Daily Trend Chart -->
            <div class="card">
                <h3>Daily Trend - {{ month_name }} {{ selected_year }}</h3>
                <div class="chart-container chart-small">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>

            <!-- Yearly Monthly Trend -->
            <div class="card">
                <h3>Monthly Trend - {{ selected_year }}</h3>
                <div class="chart-container chart-small">
                    <canvas id="yearlyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Category Expense Pie Chart -->
            <div class="card">
                <h3>Expense by Category - {{ month_name }}</h3>
                <div class="chart-container chart-small">
                    <canvas id="expensePieChart"></canvas>
                </div>
            </div>

            <!-- Category Income Pie Chart -->
            <div class="card">
                <h3>Income by Category - {{ month_name }}</h3>
                <div class="chart-container chart-small">
                    <canvas id="incomePieChart"></canvas>
                </div>
            </div>

            <!-- Category Tables -->
            <div class="card">
                <h3>Category Breakdown - {{ month_name }}</h3>
                <div class="category-breakdown" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: #e74c3c; margin-bottom: 10px;">Expenses</h4>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for c in category_expense %}
                                    <tr>
                                        <td>{{ c.category }}</td>
                                        <td style="color: #e74c3c; font-weight: 600;">‚Çπ{{ c.total|floatformat:0|intcomma }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" style="text-align: center; color: #7f8c8d;">No expenses</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #2ecc71; margin-bottom: 10px;">Income</h4>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for c in category_income %}
                                    <tr>
                                        <td>{{ c.category }}</td>
                                        <td style="color: #2ecc71; font-weight: 600;">‚Çπ{{ c.total|floatformat:0|intcomma }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" style="text-align: center; color: #7f8c8d;">No income</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Daily Chart
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: {{ daily_labels|safe }},
                datasets: [{
                    label: 'Income',
                    data: {{ daily_income|safe }},
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Expense',
                    data: {{ daily_expense|safe }},
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: {
                    x: { title: { display: true, text: 'Day' } },
                    y: { title: { display: true, text: 'Amount (‚Çπ)' }, beginAtZero: true }
                }
            }
        });

        // Yearly Monthly Chart
        const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
        new Chart(yearlyCtx, {
            type: 'bar',
            data: {
                labels: {{ month_labels|safe }},
                datasets: [{
                    label: 'Income',
                    data: {{ yearly_income|safe }},
                    backgroundColor: '#2ecc71',
                    borderRadius: 4
                }, {
                    label: 'Expense',
                    data: {{ yearly_expense|safe }},
                    backgroundColor: '#e74c3c',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: {
                    x: { title: { display: true, text: 'Month' } },
                    y: { title: { display: true, text: 'Amount (‚Çπ)' }, beginAtZero: true }
                }
            }
        });

        // Expense Pie Chart
        const expenseCtx = document.getElementById('expensePieChart').getContext('2d');
        const expenseCategories = [{% for c in category_expense %}"{{ c.category }}"{% if not forloop.last %},{% endif %}{% endfor %}];
        const expenseData = [{% for c in category_expense %}{{ c.total }}{% if not forloop.last %},{% endif %}{% endfor %}];
        
        new Chart(expenseCtx, {
            type: 'doughnut',
            data: {
                labels: expenseCategories,
                datasets: [{
                    data: expenseData,
                    backgroundColor: ['#e74c3c', '#f39c12', '#9b59b6', '#3498db', '#1abc9c', '#34495e', '#e67e22', '#95a5a6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // Income Pie Chart
        const incomeCtx = document.getElementById('incomePieChart').getContext('2d');
        const incomeCategories = [{% for c in category_income %}"{{ c.category }}"{% if not forloop.last %},{% endif %}{% endfor %}];
        const incomeData = [{% for c in category_income %}{{ c.total }}{% if not forloop.last %},{% endif %}{% endfor %}];
        
        new Chart(incomeCtx, {
            type: 'doughnut',
            data: {
                labels: incomeCategories,
                datasets: [{
                    data: incomeData,
                    backgroundColor: ['#2ecc71', '#27ae60', '#16a085', '#1abc9c', '#3498db', '#2980b9', '#9b59b6', '#8e44ad']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    </script>
</body>
</html>